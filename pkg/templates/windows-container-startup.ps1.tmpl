$ErrorActionPreference = 'Stop'

Write-Host 'Starting infisical agent...'

{{if eq .ExitAfterAuth true}}
$timeoutSeconds = {{.TimeoutSeconds}}
$process = Start-Process -FilePath 'infisical.exe' -ArgumentList 'agent' -NoNewWindow -PassThru -Wait:$false
$finished = $process.WaitForExit($timeoutSeconds * 1000)
if (-not $finished) {
    $process.Kill()
    Remove-Variable process
    Write-Error "Agent timed out after $timeoutSeconds seconds"
    exit 1
}
Start-Sleep -Milliseconds 1000
$exitCode = $process.ExitCode
Remove-Variable process
if ($null -ne $exitCode -and $exitCode -ne 0) {
    Write-Error "Agent failed with exit code $exitCode"
    exit $exitCode
}
{{else}}
$process = Start-Process -FilePath 'infisical.exe' -ArgumentList 'agent' -NoNewWindow -PassThru -Wait
if ($process.ExitCode -ne 0) {
    Write-Error "Agent failed with exit code $($process.ExitCode)"
    exit $process.ExitCode
}
{{end}}