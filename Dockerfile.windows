# Build stage - use Linux to cross-compile for Windows
FROM --platform=linux/amd64 golang:1.24-alpine AS builder

WORKDIR /app

# Copy go mod and sum files
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy source code
COPY . .

# Cross-compile for Windows AMD64
RUN CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o infisical-agent-injector.exe

# Final stage - use nanoserver for smallest Windows image
FROM --platform=windows/amd64 mcr.microsoft.com/powershell:nanoserver-ltsc2022

WORKDIR /app

# Copy the Windows binary from Linux builder
COPY --from=builder /app/infisical-agent-injector.exe /app/

ENTRYPOINT ["C:\\app\\infisical-agent-injector.exe"]